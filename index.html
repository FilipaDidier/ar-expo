<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script>
      AFRAME.registerComponent('ink-wave', {
        init: function () {
          this.particles = [];
          const el = this.el;
          const count = 200;
          const blues = ['#0d2a45', '#1a3a5c', '#2a5a8c', '#4a7fa5', '#163854', '#1e4d6b', '#5b8fad'];

          for (let i = 0; i < count; i++) {
            const dot = document.createElement('a-sphere');

            // Spread across the blue region
            const x = (Math.random() - 0.55) * 0.52;
            const y = (Math.random() - 0.3)  * 0.42;

            const radius = 0.002 + Math.random() * 0.005;
            const color  = blues[Math.floor(Math.random() * blues.length)];

            // Wave phase based on X position → wave travels left to right
            // Plus random offset so it doesn't look too uniform
            const wavePhase = (x + 0.26) / 0.52 * Math.PI * 2 + (Math.random() - 0.5) * 1.2;

            // Orbit size — how far toward viewer and how much Y arc
            const orbitZ = 0.18 + Math.random() * 0.22;
            const orbitY = 0.04 + Math.random() * 0.08;

            // Speed variation
            const speed  = 1.2 + Math.random() * 1.6; // seconds per orbit

            dot.setAttribute('radius', radius);
            dot.setAttribute('color', color);
            dot.setAttribute('material', 'transparent: true; opacity: 0; shader: flat');
            dot.setAttribute('position', `${x} ${y} 0`);

            el.appendChild(dot);

            this.particles.push({
              el: dot,
              baseX: x,
              baseY: y,
              wavePhase,
              orbitZ,
              orbitY,
              speed,
              // stagger start so they're already mid-journey
              progress: Math.random(),
              ready: false
            });
          }
        },

        tick: function (t, dt) {
          const dtSec = dt * 0.001;

          this.particles.forEach(p => {
            if (!p.ready) {
              if (!p.el.object3D) return;
              p.ready = true;
            }

            // Advance progress 0→1, loop
            p.progress += dtSec / p.speed;
            if (p.progress > 1) p.progress -= 1;

            const angle = p.progress * Math.PI * 2 + p.wavePhase;

            // Circular orbit in Z:
            // z goes 0 (surface) → orbitZ (toward viewer) → 0 → -orbitZ (behind painting) → 0
            // We only show particles when z >= 0 (in front of painting)
            const z = p.orbitZ * Math.sin(angle);
            const yArc = p.orbitY * (1 - Math.cos(angle)) * 0.5;

            const obj = p.el.object3D;
            obj.position.set(p.baseX, p.baseY + yArc, Math.max(z, 0));

            // Opacity: visible only when in front of painting (z > 0)
            // Fades in as it emerges, fades out as it returns
            let opacity = 0;
            if (z > 0) {
              // z normalized 0→1→0 during front half of orbit
              const norm = z / p.orbitZ;
              opacity = Math.sin(norm * Math.PI) * 0.9;
            }

            const mesh = p.el.getObject3D('mesh');
            if (mesh && mesh.material) {
              mesh.material.opacity = opacity;
            }
          });
        }
      });
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: true;"
      color-space="sRGB"
      renderer="colorManagement: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-entity ink-wave></a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
