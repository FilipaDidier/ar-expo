<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script>
      AFRAME.registerComponent('ink-stream', {
        init: function () {
          this.particles = [];
          this.time = 0;
          const el = this.el;
          const count = 500;
          const blues = ['#0d2a45', '#1a3a5c', '#2a5a8c', '#4a7fa5', '#163854'];

          // PATH: three points defining the arc
          // A = start on painting (dense blue area, upper-left)
          // B = farthest point toward viewer (lower, closer)
          // C = return point on painting (same blue zone)
          this.A = { x: -0.13, y:  0.10, z: 0.0  };
          this.B = { x: -0.02, y: -0.06, z: 0.40  };
          this.C = { x: -0.13, y:  0.10, z: 0.0  };

          for (let i = 0; i < count; i++) {
            const dot = document.createElement('a-sphere');

            const radius = 0.002 + Math.random() * 0.003;
            const color  = blues[Math.floor(Math.random() * blues.length)];

            // Spread particles evenly along the path at start
            const progress = i / count;

            // Tiny perpendicular jitter to give the stream width
            const jitterX = (Math.random() - 0.5) * 0.04;
            const jitterY = (Math.random() - 0.5) * 0.04;

            dot.setAttribute('radius', radius);
            dot.setAttribute('color', color);
            dot.setAttribute('material', 'transparent: true; opacity: 0; shader: flat');
            el.appendChild(dot);

            this.particles.push({
              el: dot,
              progress,
              jitterX,
              jitterY,
              speed: 0.18 + Math.random() * 0.04, // very close speeds = moves as one body
              ready: false
            });
          }
        },

        // Quadratic bezier between three points
        bezier: function(A, B, C, t) {
          const u = 1 - t;
          return {
            x: u * u * A.x + 2 * u * t * B.x + t * t * C.x,
            y: u * u * A.y + 2 * u * t * B.y + t * t * C.y,
            z: u * u * A.z + 2 * u * t * B.z + t * t * C.z,
          };
        },

        tick: function (t, dt) {
          this.time += dt * 0.001;
          const A = this.A, B = this.B, C = this.C;

          this.particles.forEach(p => {
            if (!p.ready) {
              if (!p.el.object3D) return;
              p.ready = true;
            }

            // Advance along path, loop
            p.progress += p.speed * 0.001 * dt * 0.001 * 60;
            if (p.progress > 1) p.progress -= 1;

            const pos = this.bezier(A, B, C, p.progress);

            p.el.object3D.position.set(
              pos.x + p.jitterX,
              pos.y + p.jitterY,
              pos.z
            );

            // Opacity: fade in leaving painting, fade out returning
            let opacity;
            const prog = p.progress;
            if (prog < 0.08) {
              opacity = prog / 0.08;
            } else if (prog > 0.88) {
              opacity = (1 - prog) / 0.12;
            } else {
              opacity = 1.0;
            }
            opacity *= 0.9;

            const mesh = p.el.getObject3D('mesh');
            if (mesh && mesh.material) {
              mesh.material.opacity = opacity;
            }
          });
        }
      });
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: true;"
      color-space="sRGB"
      renderer="colorManagement: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-entity ink-stream></a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
