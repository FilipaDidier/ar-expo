<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script>
      AFRAME.registerComponent('ink-wave', {
        init: function () {
          this.particles = [];
          this.time = 0;
          const el = this.el;
          const count = 80;
          const blues = ['#0d2a45', '#1a3a5c', '#2a5a8c', '#4a7fa5', '#163854', '#1e4d6b'];

          for (let i = 0; i < count; i++) {
            const shard = document.createElement('a-plane');

            // Distribute across the blue region of the painting
            const x = (Math.random() - 0.5) * 0.5;
            const y = (Math.random() - 0.5) * 0.4;

            const w = 0.005 + Math.random() * 0.014;
            const h = w * (0.5 + Math.random() * 3);
            const color = blues[Math.floor(Math.random() * blues.length)];
            const baseOpacity = 0.5 + Math.random() * 0.4;
            const phaseOffset = Math.random() * Math.PI * 2;
            const waveFreq = 0.8 + Math.random() * 1.2;
            const waveAmp = 0.06 + Math.random() * 0.12; // how far toward viewer
            const sway = 0.015 + Math.random() * 0.025;  // side sway
            const tiltSpeed = 0.3 + Math.random() * 0.7;
            const baseRot = Math.random() * 360;

            shard.setAttribute('width', w);
            shard.setAttribute('height', h);
            shard.setAttribute('color', color);
            shard.setAttribute('material', `transparent: true; opacity: ${baseOpacity}; shader: flat; side: double`);
            shard.setAttribute('position', `${x} ${y} 0`);

            el.appendChild(shard);

            this.particles.push({
              el: shard,
              baseX: x,
              baseY: y,
              phaseOffset,
              waveFreq,
              waveAmp,
              sway,
              tiltSpeed,
              baseRot,
              baseOpacity
            });
          }
        },

        tick: function (t, dt) {
          this.time += dt * 0.001; // convert to seconds
          const T = this.time;

          this.particles.forEach(p => {
            const wave = Math.sin(T * p.waveFreq + p.phaseOffset);
            const wave2 = Math.cos(T * p.waveFreq * 0.7 + p.phaseOffset);

            const z = p.waveAmp * (wave + 1) * 0.5;         // 0 to waveAmp, always positive (toward viewer)
            const x = p.baseX + wave2 * p.sway;
            const y = p.baseY + wave * p.sway * 0.5;
            const rotZ = p.baseRot + wave * 25 * p.tiltSpeed;
            const rotX = wave2 * 15;

            const opacity = p.baseOpacity * (0.4 + 0.6 * ((wave + 1) * 0.5));

            p.el.setAttribute('position', `${x} ${y} ${z}`);
            p.el.setAttribute('rotation', `${rotX} 0 ${rotZ}`);
            p.el.object3D.material && (p.el.object3D.material.opacity = opacity);
          });
        }
      });
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: true;"
      color-space="sRGB"
      renderer="colorManagement: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-entity ink-wave></a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
