<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script>
      AFRAME.registerComponent('pigment-dance', {
        init: function () {
          const el = this.el;
          const blues = ['#1a3a5c', '#2a5a8c', '#4a7fa5', '#1e4d6b', '#3b6e91', '#0d2a45', '#163854', '#5b8fad'];

          // Create multiple orbit groups, each anchored to a point on the blue area
          const orbits = [
            { x: -0.15, y:  0.12, rotTo: '360 0 0',   dur: 4200 },
            { x:  0.05, y:  0.08, rotTo: '0 0 360',   dur: 5800 },
            { x: -0.08, y: -0.05, rotTo: '360 0 0',   dur: 3900 },
            { x:  0.10, y:  0.15, rotTo: '0 360 0',   dur: 6500 },
            { x: -0.20, y:  0.00, rotTo: '360 360 0', dur: 5200 },
            { x:  0.00, y: -0.10, rotTo: '0 0 360',   dur: 4700 },
          ];

          orbits.forEach((orbit, oi) => {
            const numParticles = 5 + Math.floor(Math.random() * 4);

            for (let i = 0; i < numParticles; i++) {
              // Pivot sits on the painting surface, in the blue zone
              const pivot = document.createElement('a-entity');
              pivot.setAttribute('position', `${orbit.x} ${orbit.y} 0.02`);

              const delay = (i / numParticles) * orbit.dur;
              pivot.setAttribute('animation__rot', `
                property: rotation;
                to: ${orbit.rotTo};
                dur: ${orbit.dur};
                loop: true;
                easing: linear;
                delay: ${delay}
              `);

              // Particle is a flat plane (not a circle) offset from pivot center
              const fragment = document.createElement('a-plane');
              const radius = 0.04 + Math.random() * 0.10;
              const w = 0.006 + Math.random() * 0.016;
              const h = w * (0.2 + Math.random() * 2.0); // tall/thin shard
              const color = blues[Math.floor(Math.random() * blues.length)];
              const opacity = 0.55 + Math.random() * 0.35;

              fragment.setAttribute('position', `${radius} 0 0`);
              fragment.setAttribute('width', w);
              fragment.setAttribute('height', h);
              fragment.setAttribute('color', color);
              fragment.setAttribute('material', `transparent: true; opacity: ${opacity}; shader: flat; side: double`);

              // Each shard is rotated randomly so it looks like tumbling pigment
              fragment.setAttribute('rotation', `
                ${Math.random() * 60 - 30}
                ${Math.random() * 60 - 30}
                ${Math.random() * 60 - 30}
              `);

              // Z-pulse: breathes toward viewer and back, out of phase with rotation
              const zDur = orbit.dur * (0.5 + Math.random() * 0.5);
              fragment.setAttribute('animation__z', `
                property: position;
                from: ${radius} 0 0;
                to: ${radius} 0 0.15;
                dur: ${zDur};
                loop: true;
                dir: alternate;
                easing: easeInOutSine;
                delay: ${delay}
              `);

              pivot.appendChild(fragment);
              el.appendChild(pivot);
            }
          });
        }
      });
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: true;"
      color-space="sRGB"
      renderer="colorManagement: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-entity pigment-dance></a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
